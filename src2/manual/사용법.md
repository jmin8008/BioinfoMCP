# BioinfoMCP Skills Converter 사용 매뉴얼

## 목차

1. [개요](#1-개요)
2. [사전 준비](#2-사전-준비)
3. [파일 구조](#3-파일-구조)
4. [CLI 사용법 (main.py)](#4-cli-사용법-mainpy)
5. [입력 형식](#5-입력-형식)
6. [출력 형식](#6-출력-형식)
7. [LLM 모델 설정](#7-llm-모델-설정)
8. [일괄 변환 (run_qiime_skills.sh)](#8-일괄-변환-run_qiime_skillssh)
9. [Python API로 직접 사용하기](#9-python-api로-직접-사용하기)
10. [검증 시스템 (skill_validator.py)](#10-검증-시스템-skill_validatorpy)
11. [문제 해결](#11-문제-해결)
12. [src/ (MCP)와의 차이점](#12-src-mcp와의-차이점)

---

## 1. 개요

`src2/`는 생물정보학 도구의 문서(PDF, Markdown, --help 출력)를 입력받아
**Claude Scientific Skills** 형식의 문서 패키지를 자동 생성하는 변환기입니다.

기존 `src/`가 MCP 서버(Python 코드 + Docker)를 생성하는 것과 달리,
`src2/`는 마크다운 기반의 Skill 문서(`SKILL.md` + 참조문서 + 예제 스크립트)를 생성합니다.

### 핵심 흐름

```
입력 (PDF/MD/--help)
    ↓
LLM 분석 (OpenAI / Azure / Gemini)
    ↓
3개 블록 파싱 (===SKILL.md===, ===REFERENCE.md===, ===EXAMPLE_SCRIPT.py===)
    ↓
자동 검증 (YAML frontmatter, 필수 섹션, 코드 구문)
    ↓
출력 (skills/<tool_name>/ 디렉토리)
```

---

## 2. 사전 준비

### 2.1 필수 패키지 설치

```bash
pip install pymupdf python-dotenv openai
```

### 2.2 환경 변수 설정

프로젝트 루트(`BioinfoMCP/`)에 `.env` 파일이 필요합니다.

```env
# 사용할 모델 이름 (필수)
MODEL_NAME = "gemini-2.5-pro"

# OpenAI를 사용하는 경우
OPENAI_API_KEY=sk-your-key-here

# Google Gemini를 사용하는 경우
GEMINI_API_KEY="your-gemini-key-here"

# Azure OpenAI를 사용하는 경우
AZURE_OPENAI_ENDPOINT='https://your-endpoint.cognitiveservices.azure.com/'
AZURE_OPENAI_KEY=your-azure-key
AZURE_OPENAI_API_VERSION="2024-12-01-preview"
```

> `.env` 파일은 `skill_converter.py`에서 `Path(__file__).parent.parent / '.env'`
> 경로로 자동 로드됩니다. 즉, `BioinfoMCP/.env`를 참조합니다.

---

## 3. 파일 구조

```
src2/
├── main.py                 # CLI 진입점 (명령행 인터페이스)
├── skill_converter.py      # 핵심 변환 클래스 (BioinfoSkillConverter)
├── skill_validator.py      # SKILL.md 유효성 검증 모듈
├── system_prompt.txt       # LLM에게 보내는 시스템 프롬프트
├── run_qiime_skills.sh     # QIIME2 도구 일괄 변환 스크립트
└── manual/                 # 이 사용 매뉴얼
    └── 사용법.md
```

---

## 4. CLI 사용법 (main.py)

### 기본 명령어

```bash
cd /home/ubuntu/bionexus/jgy/biomcp/BioinfoMCP/src2

python -m main --name <도구이름> --manual <문서경로> [옵션들]
```

### 전체 옵션

| 옵션 | 필수 | 기본값 | 설명 |
|------|------|--------|------|
| `--name` | O | - | 도구 이름 (예: `qiime_tools_import`) |
| `--manual` | O | - | 도구 문서 경로 (PDF 또는 MD 파일) |
| `--run_help_command` | X | `False` | `True`면 `--manual`을 help 플래그로 사용하여 CLI 실행 |
| `--output_location` | X | `./skills/` | 출력 디렉토리 경로 |
| `--model` | X | `openai` | LLM 백엔드 선택: `openai`, `azure`, `gemini` |
| `--author` | X | `BioinfoMCP` | YAML frontmatter의 skill-author 값 |
| `--license` | X | `BSD-3-Clause` | YAML frontmatter의 license 값 |

### 사용 예시

#### PDF 문서에서 Skill 생성 (가장 일반적)

```bash
python -m main \
  --name "qiime_tools_import" \
  --manual /home/ubuntu/bionexus/jgy/biomcp/BioinfoMCP/combined.pdf \
  --output_location ./skills/ \
  --model gemini
```

#### Markdown 문서에서 Skill 생성

```bash
python -m main \
  --name "samtools_sort" \
  --manual /path/to/samtools_docs.md \
  --output_location ./skills/ \
  --model openai
```

#### CLI --help 출력에서 Skill 생성

```bash
python -m main \
  --name "fastqc" \
  --manual "--help" \
  --run_help_command True \
  --output_location ./skills/
```

> `--run_help_command True`인 경우, 해당 도구가 시스템에 설치되어 있어야 합니다.

#### 저자 및 라이선스 지정

```bash
python -m main \
  --name "qiime_dada2_denoise_single" \
  --manual ./combined.pdf \
  --output_location ./skills/ \
  --model gemini \
  --author "MyLab" \
  --license "MIT"
```

---

## 5. 입력 형식

변환기는 3가지 입력 형식을 지원합니다:

| 입력 형식 | `--manual` 값 | `--run_help_command` | 설명 |
|-----------|---------------|----------------------|------|
| PDF 파일 | 파일 경로 (`.pdf`) | `False` (기본값) | pymupdf로 텍스트 추출 |
| Markdown 파일 | 파일 경로 (`.md`) | `False` (기본값) | 파일을 그대로 읽음 |
| CLI --help | help 플래그 (예: `--help`) | `True` | subprocess로 명령 실행 후 stdout/stderr 캡처 |

### 입력 형식 자동 감지

- `--run_help_command`가 `False`일 때:
  - 파일 확장자가 `.md`이면 마크다운 파일로 처리
  - 그 외(`.pdf` 등)이면 PDF로 처리
- `--run_help_command`가 `True`일 때:
  - `--name`에 해당하는 도구를 직접 실행하여 help 출력 캡처

---

## 6. 출력 형식

성공 시 다음과 같은 디렉토리 구조가 생성됩니다:

```
skills/
└── qiime_tools_import/
    ├── SKILL.md                                    # 메인 Skill 문서
    ├── references/
    │   └── qiime_tools_import_reference.md         # 상세 파라미터 레퍼런스
    └── scripts/
        └── qiime_tools_import_example.py           # 예제 Python 스크립트
```

### SKILL.md 구조

SKILL.md는 반드시 다음 구조를 따릅니다:

```markdown
---
name: "qiime_tools_import"
description: "QIIME 2 데이터 임포트 도구"
license: "BSD-3-Clause"
context: fork
metadata:
  skill-author: "BioinfoMCP"
---

# Overview
(도구 개요)

# When to Use This Skill
(사용 시나리오)

# Core Capabilities
(핵심 기능 목록)

# Installation and Setup
(설치 방법)

# Quick Start
(최소 실행 예제)

# Standard Workflow
(표준 워크플로우)

# Common Tasks
(자주 사용하는 작업)

# Key Parameters
(파라미터 테이블)

# Best Practices
(모범 사례)

# Common Pitfalls
(주의사항)

# Additional Resources
(추가 자료)

# Bundled Resources
(번들 리소스 참조)
```

### 참조 문서 (references/)

- 모든 파라미터의 상세 설명
- 입출력 형식 명세
- 고급 사용 예제
- 문제 해결 가이드

### 예제 스크립트 (scripts/)

- 유효한 Python 스크립트
- subprocess를 통한 CLI 도구 호출 예시
- argparse를 활용한 경로 설정
- 에러 처리 포함

> 예제 스크립트가 비어있으면 파일이 생성되지 않습니다.

---

## 7. LLM 모델 설정

### 지원하는 모델 백엔드

| 백엔드 | `--model` 값 | 필요한 환경 변수 |
|--------|-------------|-----------------|
| OpenAI | `openai` | `OPENAI_API_KEY`, `MODEL_NAME` |
| Azure OpenAI | `azure` | `AZURE_OPENAI_KEY`, `AZURE_OPENAI_ENDPOINT`, `AZURE_OPENAI_API_VERSION`, `MODEL_NAME` |
| Google Gemini | `gemini` | `GEMINI_API_KEY`, `MODEL_NAME` |

### MODEL_NAME 예시

`.env`의 `MODEL_NAME`에 설정 가능한 값:

- OpenAI: `gpt-4o`, `gpt-4o-mini`, `gpt-4.1-turbo`
- Azure: `gpt-4o` (Azure 배포명)
- Gemini: `gemini-2.5-pro`, `gemini-2.0-flash`

> `--model` 플래그는 API 클라이언트만 결정하고,
> 실제 모델 이름은 `.env`의 `MODEL_NAME`을 사용합니다.

---

## 8. 일괄 변환 (run_qiime_skills.sh)

QIIME 2의 68개 이상 도구를 한번에 변환하려면:

```bash
cd /home/ubuntu/bionexus/jgy/biomcp/BioinfoMCP/src2
bash run_qiime_skills.sh
```

### 포함된 도구 카테고리

| 카테고리 | 도구 수 | 예시 |
|----------|---------|------|
| Core Framework | 9 | `qiime_tools_import`, `qiime_tools_export` |
| Demux & QC | 9 | `qiime_demux_emp_single`, `qiime_cutadapt_trim_single` |
| Denoising | 10 | `qiime_dada2_denoise_single`, `qiime_deblur_denoise_16S` |
| Phylogeny | 7 | `qiime_alignment_mafft`, `qiime_phylogeny_fasttree` |
| Taxonomy | 8 | `qiime_feature_classifier_classify_sklearn`, `qiime_taxa_barplot` |
| Diversity | 10 | `qiime_diversity_alpha`, `qiime_emperor_plot` |
| Stats & ML | 10 | `qiime_composition_ancom`, `qiime_longitudinal_volatility` |
| Utils | 9 | `qiime_feature_table_summarize`, `qiime_metadata_tabulate` |
| Extensions | 4 | `qiime_rescript`, `qiime_picrust2` |

> 모든 도구는 `combined.pdf`를 입력 문서로 사용하며, `gemini` 모델로 변환됩니다.

---

## 9. Python API로 직접 사용하기

CLI 대신 Python 코드에서 직접 변환기를 사용할 수 있습니다:

### 기본 사용

```python
from skill_converter import BioinfoSkillConverter

# 변환기 초기화
converter = BioinfoSkillConverter(
    model="gemini",          # openai, azure, gemini 중 선택
    author="MyLab",          # YAML frontmatter 저자
    license_name="MIT"       # YAML frontmatter 라이선스
)

# Skill 생성
result = converter.autogenerate_skill(
    tool_name="qiime_tools_import",
    manual="/path/to/combined.pdf",
    run_help_command=False
)

# 결과 확인
success, error, contents = result
if success:
    print(contents["skill_md"])       # SKILL.md 내용
    print(contents["reference_md"])   # 참조 문서 내용
    print(contents["example_script"]) # 예제 스크립트 내용
else:
    print(f"실패: {error}")
```

### 재시도 로직 포함 사용

```python
from main import convert_skill, write_skill_files

# 자동 재시도 포함 변환
contents = convert_skill(
    tool_name="qiime_dada2_denoise_single",
    manual="/path/to/combined.pdf",
    run_help_command=False,
    model="gemini",
    author="BioinfoMCP",
    license_name="BSD-3-Clause"
)

# 파일로 저장
skill_dir = write_skill_files(
    tool_name="qiime_dada2_denoise_single",
    contents=contents,
    output_dir="./skills/"
)
print(f"생성 완료: {skill_dir}")
```

### 개별 메서드 활용

```python
converter = BioinfoSkillConverter(model="gemini")

# 1. 문서 추출만 수행
help_text = converter.extract_help_document(
    tool_name="qiime_tools_import",
    manual="/path/to/document.pdf",
    run_help_command=False
)

# 2. 프롬프트 생성
prompt = converter.generate_prompt("qiime_tools_import", help_text)

# 3. 검증만 수행 (별도 모듈)
from skill_validator import validate_skill_md
success, error = validate_skill_md(some_skill_md_content)
```

---

## 10. 검증 시스템 (skill_validator.py)

변환기는 LLM 출력을 자동으로 검증합니다. 검증에 실패하면 LLM에게 수정을 요청하는 재시도 루프가 동작합니다.

### 검증 항목

#### SKILL.md 검증 (`validate_skill_md`)

| 검증 항목 | 설명 |
|-----------|------|
| YAML frontmatter 존재 | `---` 구분자 사이의 YAML 블록 |
| 필수 frontmatter 키 | `name`, `description`, `license`, `context`, `metadata` |
| 필수 섹션 12개 | Overview, When to Use This Skill, Core Capabilities, Installation and Setup, Quick Start, Standard Workflow, Common Tasks, Key Parameters, Best Practices, Common Pitfalls, Additional Resources, Bundled Resources |
| 코드 블록 존재 | 최소 1개의 ` ``` ` 코드 블록 |

#### 참조 문서 검증 (`validate_reference_md`)

| 검증 항목 | 설명 |
|-----------|------|
| 비어있지 않음 | 내용이 존재해야 함 |
| 헤더 존재 | 최소 1개의 `#` 헤더 |

#### 예제 스크립트 검증 (`validate_example_script`)

| 검증 항목 | 설명 |
|-----------|------|
| 빈 내용 허용 | 비어있으면 통과 (파일 미생성) |
| Python 구문 검사 | 내용이 있으면 `ast.parse()`로 구문 검증 |

### 반환 형식

모든 검증 함수는 동일한 형식을 반환합니다:

```python
(1, None)           # 성공
(0, "에러 메시지")   # 실패
```

---

## 11. 문제 해결

### 자주 발생하는 오류

#### `ModuleNotFoundError: No module named 'pymupdf'`

```bash
pip install pymupdf
```

#### `ModuleNotFoundError: No module named 'dotenv'`

```bash
pip install python-dotenv
```

#### `ModuleNotFoundError: No module named 'openai'`

```bash
pip install openai
```

#### `.env 파일을 찾을 수 없음`

`.env` 파일은 `BioinfoMCP/` 루트에 위치해야 합니다 (`src2/`가 아님).

```
BioinfoMCP/
├── .env          ← 여기
├── src/
└── src2/
```

#### `MODEL_NAME 환경 변수가 None`

`.env` 파일에 `MODEL_NAME`을 반드시 설정하세요:

```env
MODEL_NAME = "gemini-2.5-pro"
```

#### 무한 재시도 루프

LLM이 계속 잘못된 형식을 생성하는 경우입니다. `Ctrl+C`로 중단 후:
- `.env`의 `MODEL_NAME`이 올바른지 확인
- API 키가 유효한지 확인
- 입력 문서가 해당 도구에 대한 충분한 정보를 포함하는지 확인

#### `===SKILL.md===` 구분자를 찾을 수 없음

LLM이 구분자 형식을 따르지 않은 경우입니다. `system_prompt.txt`의 구분자 지시를 확인하세요.

---

## 12. src/ (MCP)와의 차이점

| 항목 | src/ (MCP 서버) | src2/ (Skills) |
|------|----------------|----------------|
| **목적** | MCP 서버 코드 자동 생성 | Claude Skill 문서 자동 생성 |
| **출력 형식** | Python `.py` 서버 코드 | Markdown `SKILL.md` 문서 |
| **검증 방식** | `ast.parse()` + `@mcp.tool` 확인 | YAML 파싱 + 12개 섹션 헤더 확인 |
| **부산물** | Dockerfile, docker-compose.yml, requirements.txt, environment.yaml | references/*.md, scripts/*.py |
| **LLM 응답 파싱** | ` ```python ``` ` 코드 블록 추출 | `===SKILL.md===` 구분자 기반 3블록 추출 |
| **입력 형식** | PDF, --help | PDF, --help, **Markdown 추가** |
| **Docker 관련** | Dockerfile/docker-compose 생성 | 없음 |
| **핵심 클래스** | `BioinfoMCP` | `BioinfoSkillConverter` |
| **CLI 옵션** | `--is_pipeline` 포함 | `--author`, `--license` 추가 |
